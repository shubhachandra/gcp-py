from google.cloud import logging_v2
import pandas as pd

PROJECT_ID = 'your-gcp-project-id'
NETWORK_ID = 'your-network-id'
OUTPUT_CSV = 'subnet_allocation_report.csv'

# Initialize the Cloud Logging client (default credentials)
logging_client = logging_v2.Client(project=PROJECT_ID)

# Define filter for Network Analyzer audit logs
log_filter = (
    f'logName="projects/{PROJECT_ID}/logs/networkanalyzer.googleapis.com%2Fanalyser_reports" '
    f'jsonPayload.resourcename="//compute.googleapis.com/projects/{NETWORK_ID}"'
)

# Retrieve log entries
entries = logging_client.list_entries(filter_=log_filter)

# Extract subnet details
subnet_data = []
for entry in entries:
    payload = entry.payload
    subnet_name = payload.get('subnet', 'Unknown')
    allocation_ratio = payload.get('allocationRatio', 'N/A')

    subnet_data.append({
        'Subnet Name': subnet_name,
        'Allocation Ratio': allocation_ratio
    })

# Create DataFrame and export to CSV
subnet_df = pd.DataFrame(subnet_data).drop_duplicates()
subnet_df.to_csv(OUTPUT_CSV, index=False)

print(f"Subnet allocation report saved to {OUTPUT_CSV}")
